<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>üí∞ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - Morris API</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
html, body {
 margin: 0;
 padding: 0;
 height: 100%;
 width: 100%;
 overflow-x: hidden;
 font-family: 'Inter', sans-serif;
 background: radial-gradient(circle at top left, #0f172a, #020617 70%);
 color: #e0e0e0;
 display: flex;
 flex-direction: column;
}

body {
 min-height: 100vh;
 overflow-y: auto;
}

.glass {
 background: rgba(255,255,255,0.05);
 backdrop-filter: blur(12px);
 border: 1px solid rgba(255,255,255,0.1);
}
.neon-border {
 border: 1px solid transparent;
 background-clip: padding-box;
 box-shadow: 0 0 12px rgba(59,130,246,0.6),
    0 0 24px rgba(168,85,247,0.5);
}

/* Mobile adjustments */
@media (max-width: 640px) {
 nav, main, header { padding-left: 1rem; padding-right: 1rem; }
 h1 { font-size: 2.25rem; }
}
</style>
</head>
<body class="min-h-screen flex flex-col">

 <nav class="flex justify-between items-center px-8 py-4 glass sticky top-0 z-50 shadow-lg">
 <a href="/api" class="text-2xl font-bold tracking-wide bg-gradient-to-r from-blue-400 via-purple-400 to-cyan-400 bg-clip-text text-transparent">
 Morris API
 </a>
 <span class="bg-green-900/30 text-green-300 text-xs font-semibold px-3 py-1 rounded-full shadow-lg">
 ‚ö° Credit : {{ token_uses_left }}
 </span>
</nav>

 <header class="text-center py-12">
 <h1 class="text-4xl font-extrabold bg-gradient-to-r from-yellow-400 via-amber-400 to-orange-500 bg-clip-text text-transparent drop-shadow-lg">
 ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
 </h1>
 <p class="mt-2 text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
</header>

 <main class="flex-grow flex flex-col items-center px-6 pb-16">
 <section class="w-full max-w-xl flex flex-col glass rounded-2xl p-6 sm:p-8 space-y-8 neon-border relative">

   <div class="border-b border-gray-700 pb-4 space-y-2">
  <h2 class="text-2xl font-bold flex items-center gap-2 text-yellow-400">
  <i data-lucide="receipt" class="w-6 h-6"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  </h2>
  <div class="flex justify-between text-lg text-gray-300 pt-2">
  <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï:</span>
  <span class="font-semibold">{{ credit_amount }} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
  </div>
  <div class="flex justify-between text-xl pt-2">
  <span class="font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
  <span class="font-extrabold text-yellow-400" id="total_price_display">{{ total_price }} ‡∏ö‡∏≤‡∏ó</span>
  </div>
 </div>

   <div class="space-y-6">
  <h2 class="text-2xl font-bold flex items-center gap-2 text-purple-400">
  <i data-lucide="wallet" class="w-6 h-6"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
   </h2>

    <div class="glass p-5 rounded-xl border border-purple-500/30 shadow-xl space-y-4">
  <button onclick="togglePaymentDetails('qr_details')" 
    class="w-full text-left font-semibold text-lg flex justify-between items-center text-white hover:text-purple-300 transition">
   <span>üè¶ PromptPay QR Code (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</span>
   <i data-lucide="chevron-down" class="w-5 h-5 transition transform" id="qr_details_icon"></i>
  </button>
  
  <div id="qr_details" class="mt-4 space-y-4 hidden pt-4 border-t border-gray-700">
    <p class="text-red-400 font-semibold text-sm">‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡∏¢‡∏≠‡∏î {{ total_price }} ‡∏ö‡∏≤‡∏ó ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
    
    <div class="flex justify-center flex-col items-center p-4 bg-gray-900/50 rounded-lg">
      
      <!-- START: NEW Logo and Instruction Section -->
      <div class="text-center mb-4 p-2 rounded-lg bg-yellow-600/20 w-full max-w-sm">
        <div class="flex items-center justify-center text-yellow-300 font-extrabold text-xl gap-2">
          <!-- Placeholder for custom PromptPay Logo -->
          <img src="/static/promptpay_logo.png" alt="PromptPay Logo" class="w-8 h-8 object-contain">
          <span class="tracking-widest">PromptPay</span>
        </div>
        <p class="text-xs text-yellow-400 mt-1">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
      </div>
      <!-- END: NEW Logo and Instruction Section -->
      
      <img src="{{ qr_code_base64 }}" alt="PromptPay QR Code" 
                id="promptpay_qr_img"
        class="w-48 h-48 border border-gray-600 rounded-lg p-2 bg-white/10 backdrop-blur-sm">
            
            <!-- START: QR Code Error Message (Hidden by default) -->
            <div id="qr_error_message" class="hidden text-center p-4 rounded-lg bg-red-900/40 border border-red-700 mt-4 max-w-sm w-full">
                <p class="text-red-400 font-bold flex items-center justify-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    QR Code ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ
                </p>
                <p class="text-sm text-red-300 mt-1">
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console Log (Python) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: **BASE64_FAIL**
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ PromptPay, qrcode ‡∏´‡∏£‡∏∑‡∏≠ Pillow
                </p>
            </div>
            <!-- END: QR Code Error Message -->

      <!-- START: Amount and Timestamp Section -->
      <div class="mt-4 text-center w-full max-w-sm p-3 bg-gray-800 rounded-lg border border-gray-700">
        <p class="text-xl font-extrabold text-cyan-400 leading-none">
          {{ total_price }} THB
        </p>
        <p class="text-xs text-gray-400 mt-1">
          ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: <span id="current_timestamp" class="font-medium text-gray-300"></span>
        </p>
      </div>
      <!-- END: Amount and Timestamp Section -->
      
      <p class="mt-2 text-sm text-gray-500">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: <span class="text-white font-medium" id="order_id_display">{{ order_id }}</span></p>
    </div>

    <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏≠/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
    <div id="status_message">
     <div id="status_pending" class="w-full bg-blue-900/40 border-l-4 border-blue-500 p-3 rounded-lg flex items-center gap-3 mt-4">
      <i data-lucide="loader" class="w-5 h-5 text-blue-300 animate-spin"></i>
      <span class="text-blue-300 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô... (‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</span>
     </div>
    </div>
  </div>

    <div class="glass p-5 rounded-xl border border-gray-500/30 shadow-md opacity-50 cursor-not-allowed">
  <div class="w-full text-left font-semibold text-lg flex justify-between items-center text-gray-500">
   <span>üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡πÄ‡∏î‡∏ö‡∏¥‡∏ï (‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ)</span>
   <i data-lucide="lock" class="w-5 h-5"></i>
  </div>
  </div>
 </div>
 
   <p class="text-xs text-gray-500 text-center pt-4">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
 </section>
 
  <div class="mt-12 text-center">
 <a href="/account" class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 transition text-lg font-medium">
  <i data-lucide="arrow-left" class="w-5 h-5"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
 </a>
 </div>

</main>

<script>
 lucide.createIcons();
 
 const ORDER_ID = '{{ order_id }}';
 let pollInterval = null;

 // Function to format the current time as DD.MM.YYYY HH:MM (Thai Buddhist year)
 function formatThaiTimestamp(date) {
  const year = date.getFullYear() + 543; // Thai Buddhist year conversion
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${day}.${month}.${year} ${hours}:${minutes}`;
 }

 // Function to toggle payment details (Accordion effect)
 function togglePaymentDetails(id) {
 const details = document.getElementById(id);
 const icon = document.getElementById(id + '_icon');

 if (details.classList.contains('hidden')) {
  details.classList.remove('hidden');
  icon.classList.add('rotate-180');
  // Start polling only when QR is shown
  if (id === 'qr_details') {
  startPolling();
  }
 } else {
  details.classList.add('hidden');
  icon.classList.remove('rotate-180');
  // Stop polling when QR is hidden
  stopPolling();
 }
 }

 // Polling Logic to check payment status against the backend
 async function pollPaymentStatus() {
  if (!ORDER_ID) return stopPolling();
  
  try {
   // Note: Polling uses exponential backoff to handle throttling gracefully.
   const maxRetries = 5;
   const initialDelay = 1000; // 1 second
   
   for (let attempt = 0; attempt < maxRetries; attempt++) {
    const response = await fetch(`/payment_status/${ORDER_ID}`);
    
    if (response.status === 429) { // Too Many Requests
     const delay = initialDelay * Math.pow(2, attempt);
     console.log(`Rate limit hit. Retrying in ${delay / 1000}s...`);
     await new Promise(resolve => setTimeout(resolve, delay));
     continue;
    }

    const data = await response.json();

    if (data.status === 'PAID') {
     stopPolling();
     console.log("Payment Confirmed! Redirecting...");
     
     const statusDiv = document.getElementById('status_pending');
     statusDiv.className = 'w-full bg-green-900/40 border-l-4 border-green-500 p-3 rounded-lg flex items-center gap-3 mt-4';
     statusDiv.innerHTML = '<i data-lucide="check-check" class="w-5 h-5 text-green-300"></i><span class="text-green-300 font-medium">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï...</span>';
     lucide.createIcons();
     
     setTimeout(() => {
      window.location.href = '/payment_success';
     }, 1500);
     return;
    } else if (data.status === 'NOT_FOUND' || data.status === 'EXPIRED') {
     stopPolling();
     console.warn("Order not found or expired. Please start a new transaction.");
     return;
    }
    // If status is PENDING, we continue to the next poll interval (outside the loop)
    break; 
   }

  } catch (error) {
   console.error("Polling error:", error);
  }
 }

 function startPolling() {
  if (pollInterval === null) {
   // ‡πÄ‡∏£‡∏¥‡πà‡∏° Polling ‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (3000ms)
   pollInterval = setInterval(pollPaymentStatus, 3000);
   console.log("Payment Polling started.");
   // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
   pollPaymentStatus();
  }
 }

 function stopPolling() {
  if (pollInterval !== null) {
   clearInterval(pollInterval);
   pollInterval = null;
   console.log("Payment Polling stopped.");
  }
 }
 
 // ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
 window.onload = () => {
  lucide.createIcons();

  // NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏´‡∏≤‡∏Å QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
    const qrImage = document.getElementById('promptpay_qr_img');
    const qrErrorDiv = document.getElementById('qr_error_message');

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ src attribute ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ã‡∏∂‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤ Python function ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏≤)
    if (qrImage && qrImage.getAttribute('src') === '') {
        qrImage.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢
        qrErrorDiv.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        stopPolling(); // ‡∏´‡∏¢‡∏∏‡∏î Polling ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ QR ‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô
    } else {
        // NEW: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        const timestampElement = document.getElementById('current_timestamp');
        if (timestampElement) {
            // Use the current time when the page loads as the creation time
            timestampElement.textContent = formatThaiTimestamp(new Date());
        }
    }

  
  // Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° Polling ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
  if ('{{ current_status }}' === 'PAID') {
   // If the status is already PAID when loading (unlikely in this flow), redirect.
   window.location.href = '/payment_success';
  } else if ('{{ current_status }}' === 'PENDING' && qrImage.getAttribute('src') !== '') {
   // If the order is pending AND the QR code is present, open details and start polling automatically.
   togglePaymentDetails('qr_details');
  }
 };
 
</script>
</body>
</html>
