<!DOCTYPE html>
  <html>
  <head><title>ยินยันตัวด้วยใบหน้า</title></head>
  <body>
    <h2>ยินยันตัวด้วยใบหน้า</h2>
    <video id="video" autoplay muted width="320" height="240" style="transform: scaleX(-1);"></video>
    <div id="status" style="margin-top:10px; font-weight:bold; font-size:1.2em;"></div>

    <div id="details">
      <div>ผู้ใช้งาน: -</div>
      <div>ค่าความมั่นใจ: -</div>
      <div>ค่าความมั่นใจการปลอมแปลง: -</div>
      <div>เวลา: -</div>
    </div>

    <script>
      const CONFIG = {
        wsUrl: "YOUR-ENDPOINT-URL",
        token: "YOUR-API-TOKEN"
      };

      const ws = new WebSocket(CONFIG.wsUrl);
      const status = document.getElementById('status');
      const video = document.getElementById('video');
      const details = document.getElementById('details').children;
      const cameraErrorMsg = "ไม่สามารถเข้าถึงกล้องได้";
      const unknownErrorMsg = "ไม่ทราบสาเหตุ";
      const labels = ["ผู้ใช้งาน", "ค่าความมั่นใจ", "ค่าความมั่นใจการปลอมแปลง", "เวลา"];

      navigator.mediaDevices.getUserMedia({video:true})
        .then(s => video.srcObject = s)
        .catch(() => { status.textContent=cameraErrorMsg; });

      ws.onopen = () => {
        if(CONFIG.token) ws.send(JSON.stringify({token: CONFIG.token}));
        sendFrame();
      };

      ws.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          const body = d.body || {};
          status.textContent = body.message || unknownErrorMsg;
          status.style.color = body.success ? "green" : "red";

          const values = body.success
            ? [
                body.subuser_id || "-", 
                body.confidence || "-", 
                body.spoof_confidence ?? body.spoofConfidence ?? "-", 
                body.timestamp || "-"
              ]
            : ["-", "-", "-", "-"];

          labels.forEach((label,i) => { details[i].textContent = label + ": " + values[i]; });
        } catch(err){ console.error(err,e.data); }
        sendFrame();
      };

      function sendFrame() {
        if(!video.videoWidth) return setTimeout(sendFrame,500);
        const c=document.createElement('canvas'), ctx=c.getContext('2d');
        c.width=video.videoWidth; c.height=video.videoHeight;
        ctx.translate(c.width,0); ctx.scale(-1,1);
        ctx.drawImage(video,0,0);
        if(ws.readyState===1) ws.send(c.toDataURL('image/jpeg'));
      }
      if (!window.opener && !window.name) {
        const popup = window.open(
          window.location.href,
          "FaceRegisterPopup",
          "width=320,height=400,resizable=no,menubar=no,toolbar=no,location=no,status=no"
        );
        if (popup) { popup.name = "FaceRegisterPopup"; window.close(); }
      }
    </script>
  </body>
  </html>