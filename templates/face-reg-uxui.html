<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ลงทะเบียนใบหน้า</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    * {box-sizing: border-box;margin:0;padding:0;}

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
      color: #1f2937;
    }

    h2 {
      font-weight: 600;
      font-size: 1.8rem;
      margin-bottom: 25px;
      color: #111827;
      text-align: center;
      letter-spacing: 0.5px;
    }

    #video {
      width: 320px;
      max-width: 90vw;
      height: 400px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 12px 25px rgba(0,0,0,0.15);
      margin-bottom: 20px;
      border: 2px solid #4f46e5;
      background: #000;
      transform: scaleX(-1);
    }

    #status {
      font-weight: 500;
      font-size: 1rem;
      padding: 12px 18px;
      border-radius: 10px;
      text-align: center;
      min-width: 260px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    #status.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #34d399;
    }

    #status.error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #f87171;
    }

    #details {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 1rem;
      color: #374151;
      background: #ffffff;
      padding: 18px 22px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      min-width: 280px;
      max-width: 90vw;
      transition: all 0.3s ease;
    }

    #details div {
      margin: 6px 0;
      font-weight: 500;
    }

    @media (max-width: 480px) {
      #video { height: 300px; }
      #details { padding: 14px 16px; }
    }
  </style>
</head>
<body>
  <h2>ลงทะเบียนใบหน้า</h2>
  <video id="video" autoplay muted></video>
  <div id="status">กำลังเริ่มต้นกล้อง…</div>
  <div id="details">
    <div>ผู้ใช้งาน: -</div>
    <div>ค่าความมั่นใจ: -</div>
    <div>ค่าความมั่นใจการปลอมแปลง: -</div>
    <div>เวลา: -</div>
  </div>
  <script>
    if (window.opener == null && !window.name) {
      const popup = window.open(
        window.location.href,
        "FaceRegisterPopup",
        "width=350,height=550,resizable=no,menubar=no,toolbar=no,location=no,status=no"
      );
      if (popup) {
        popup.name = "FaceRegisterPopup";
        window.close();
      }
    }
    const CONFIG = {
      wsUrl: "ws://localhost:8000/api/ws/face-register/",
      token: "985fdf33-b7df-4945-84d2-79739097eeed"
    };
    const ws = new WebSocket(CONFIG.wsUrl);
    const status = document.getElementById('status');
    const video = document.getElementById('video');
    const details = document.getElementById('details').children;

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(() => {
        status.textContent = "ไม่สามารถเข้าถึงกล้องได้";
        status.className = "error";
      });

    ws.onopen = () => {
      if(CONFIG.token) ws.send(JSON.stringify({token: CONFIG.token}));
      sendFrame();
    };

    ws.onmessage = e => {
      try {
        const d = JSON.parse(e.data);
        const body = d.body || {};
        status.textContent = body.message || "ไม่ทราบสาเหตุ";
        status.className = body.success ? "success" : "error";

        if (body.success) {
          details[0].textContent = "ผู้ใช้งาน: " + (body.subuser_id ?? "-");
          details[1].textContent = "ค่าความมั่นใจ: " + (body.confidence ?? "-");
          details[2].textContent = "ค่าความมั่นใจการปลอมแปลง: " + (body.spoof_confidence ?? "-");
          details[3].textContent = "เวลา: " + (body.timestamp ?? "-");
        } else {
          details[0].textContent = "ผู้ใช้งาน: -";
          details[1].textContent = "ค่าความมั่นใจ: -";
          details[2].textContent = "ค่าความมั่นใจการปลอมแปลง: -";
          details[3].textContent = "เวลา: -";
        }
      } catch(err){ 
        console.error(err, e.data); 
      }
      sendFrame();
    };

    function sendFrame() {
      if(!video.videoWidth) return setTimeout(sendFrame, 500);
      const c = document.createElement('canvas'), ctx = c.getContext('2d');
      c.width = video.videoWidth;
      c.height = video.videoHeight;
      ctx.translate(c.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      if(ws.readyState === 1) ws.send(c.toDataURL('image/jpeg'));
    }
  </script>
</body>
</html>
